---
title: "Final Project (Team 7)"
author: "Sahil Wadhwa"
---

```{r}
#Packages Used

library(caret)
library(ggplot2)
library(corrplot)
library(tidyr)
library(ROSE)
library(gt)
```

```{r}
#Loading Datasets (Train and Test)

smoke_main <- read.csv("train_dataset.csv")
smoke_minor <- read.csv("test_dataset.csv")

#Train: 12347 observations, 14 variables
#Test: 5000 observations, 15 variables
```

```{r}
#Finding missing values

na_values <- sapply(smoke_main, function(x) sum(is.na(x)))
na_values

#There are no missing values that we need to work on
```
```{r}
#EDA

#Histogram for every predictor
smoke_main |>
  pivot_longer(-Fire.Alarm, names_to = 'UTC') |>
  ggplot(aes(x = value)) + geom_histogram(bins = 15) + 
  facet_wrap(~UTC, scales = 'free') + 
  labs(title = 'Predictors Histograms')
```
```{r}
#Correlation before removing anything

#Corrplot between variables 
corr <- cor(smoke_main)
corrplot(corr, method = 'color', order = 'alphabet')
```
```{r}
#Removing highly correlated predictors and updated corrplot

corr_matrix <- cor(smoke_main[, -1])
high_correlation_index <- findCorrelation(corr_matrix, cutoff = 0.7)
smoke_updated_main <- smoke_main[, -high_correlation_index]

corr <- cor(smoke_updated_main)
corrplot(corr, method = 'color', order = 'alphabet')
```

```{r}
#Splitting datasets (80-20 split). Only with the 8 remaining predictors

set.seed(100)
smokedf_predictors <- smoke_updated_main[ ,-1]
smokedf_yield <- smoke_updated_main[ ,1]

# Split the data into training and test sets
smokedf_index <- createDataPartition(smokedf_yield, p = 0.8, list = FALSE)
smokedf_train <- smokedf_predictors[smokedf_index, ]
smokedf_test <- smokedf_predictors[-smokedf_index, ]

smokedf_prep <- preProcess(smokedf_train, method = c("center", "scale"))

# Apply the transformation to the training data
smokedf_train_transformed <- predict(smokedf_prep, smokedf_train)
smokedf_test_transformed <- predict(smokedf_prep, smokedf_test)

# Rebalance train dataset
cat("Number of non-triggered fire alarm (No) = ", 
    sum(smokedf_train_transformed$Fire.Alarm == "No"), "\n") 
cat("Number of triggered fire alarm (Yes) =", 
    sum(smokedf_train_transformed$Fire.Alarm == "Yes"))

train_balanced <- ROSE(Fire.Alarm ~ ., data = smokedf_train_transformed)$data

rebalanced <- as.data.frame(table(train_balanced$Fire.Alarm)) 
rebalanced |> gt() |> 
  tab_header(title = "Rebalanced Fire Alarm Counts")
```

```{r}
#Model #1: KNN

set.seed(100)
knnTune <- train(Fire.Alarm ~ ., data = train_balanced,
                method = "knn",
                preProc = c("center","scale"),
                tuneGrid = data.frame(k = 1:20))

knnTune
plot(knnTune)
```
```{r}
#Model 2: MARS

set.seed(100)
marsTune <- train(Fire.Alarm ~ ., data = train_balanced,
                  method = "earth",
                  tuneGrid = expand.grid(degree = 1, nprune = 2:38))
marsTune
plot(marsTune)
```
```{r}
#Predictors and Confusion Matrix for KNN

test_predictors <- smokedf_test_transformed[, -8]
test_org <- data.frame(Fire.Alarm = smokedf_test_transformed$Fire.Alarm)
test_org$Fire.Alarm <- factor(test_org$Fire.Alarm)

knn_predictions <- predict(knnTune, newdata = test_predictors, type = "raw")
knn_predictions <- data.frame(Fire.Alarm = knn_predictions)

cm_knn <- confusionMatrix(data = as.factor(knn_predictions$Fire.Alarm),
                               reference = test_org$Fire.Alarm, positive = "Yes")
cm_knn
```


```{r}
#Predictors and Confusion Matrix for Mars

mars_predictions <- predict(marsTune, newdata = test_predictors, type = "raw")
mars_predictions <- data.frame(Fire.Alarm = mars_predictions)

cm_mars <- confusionMatrix(data = as.factor(mars_predictions$Fire.Alarm),
                               reference = test_org$Fire.Alarm, positive = "Yes")
cm_mars
```

#Performance Evaluation of KNN

```{r}
#Most optimal value of K is 11
#When k = 11, RMSE is 0.669
```

#Performance Evaluation of MARS

```{r}
#Most optimal value of nprune is 13
#When nprune = 13, RMSE = 0.761
```







